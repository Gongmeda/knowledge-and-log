# OAuth 2.0

## 용도 및 등장 배경

- 서드파티 서비스에 대한 사용자 정보에 대한 권한을 서비스가 얻기 위해 등장
- 그 전에는 서드파티 서비스의 인증 정보(아이디 & 비밀번호)를 서비스에 등록해야 됐음 (e.g. 'LinkedIn이 내 Gmail 주소록을 가져와 친구를 추천해주고 싶어하는' 상황이라면 LinkedIn에 구글 아이디/비밀번호를 등록)
- 이는 과도한 권한, 액세스 취소가 불가능한 문제가 있었고 OAuth가 이를 해결해줌

## 권한 부여 과정

1. 권한 요청: LinkedIn(클라이언트)은 사용자 브라우저를 Gmail의 authorization endpoint로 리디렉션하여 특정 정보(예: 주소록 읽기)에 대한 접근 권한을 요청
2. 사용자 동의: 사용자는 Gmail 로그인 화면에서 LinkedIn에게 '주소록 읽기' 권한만 허용하겠다고 명시적으로 **동의(Consent)**함
3. 임시 허가증 발급: 사용자의 동의를 확인한 Gmail의 '인증 서버(Authorization Server)' 는 사용자를 다시 LinkedIn으로 리디렉션하며, 이때 일회용 인증 코드(Authorization Code) 라는 임시 허가증을 함께 전달
4. 출입증 교환: LinkedIn의 백엔드 서버는 자신의 신분증(client ID/client secret)과 함께 받은 인증 코드를 인증 서버의 token endpoint에 제출
5. 접근 토큰 발급 및 제한된 접근: 인증 서버는 모든 정보가 유효함을 확인한 뒤, 최종적으로 접근 토큰(Access Token) 이라는 출입증을 발급
6. LinkedIn은 이 접근 토큰을 가지고 Gmail API(리소스 서버)에 접근하며, API는 토큰을 확인하고 사용자가 동의한 '주소록 읽기' 작업만 허용

### 클라이언트는 어떻게 인증이 완료됐는지 알 수 있는가?

#### 웹

query string에 포함시킨 리다이렉션 방식

- redirect URI로 이동 (302 응답. 응답의 Location 헤더에 이동 대상 주소가 포함)
- 이때, redirect URI에 인증 코드를 포함하기 때문에 이를 읽어 해당 주소의 페이지에서 인증 코드를 서버로 전송 (인증 코드를 읽고 서버로 전송하는건 직접 구현해야 함)
- 서버에서는 인증 코드 -> 리소스 소유자 인증서버에 요청 -> access token 발급 -> access token으로 추가 정보 요청 (서드파티 API 호출) -> 응답
- 인증이 아닌, 서드파티 서비스 연동의 경우는 access token을 서버에 저장하여 사용 (refresh token을 함께 저장하고 배치 등으로 갱신하며 처리)

form_post 방식

- 서드파티 인증 사이트에서 redirect URI 응답이 아닌 HTML(form)을 응답
- 브라우저가 자동 POST로 서버에 인증 코드를 전달하고, 302 응답
- 나머지는 동일

#### 모바일

- WebView가 특정 redirect URI로 이동했음을 감지
- URL이 사전에 정한 값과 매칭되면 WebView 닫고 code를 서버로 전달하거나 완료 화면 표시

### 리소스 소유자측 앱을 통해 직접 인증하는 경우는 어떻게 동작하는가? (돌아가서 인증 완료하기 기능)

- 딥링크: redirect URI가 딥링크 기반이라 호출한 앱으로 돌아가면서 인증 코드가 앱으로 전달되는 방식
- 폴링/세션: 서드파티 측에서 인증 완료 후 인증 요청측 서버로 요청(redirect URI 기반). 앱으로 돌아가면 서버에 인증 완료 여부를 확인하여 처리

# OIDC

- OAuth 2.0 위에서 동작하는 인증을 위한 계층
- OAuth 2.0은 리소스 서버로부터 리소스를 가져오기 위한 액세스 토큰 확보에 목적이 있다면, OIDC(OpenID Connect)는 사용자의 신원 정보가 담긴 ID 토큰 확보에 그 목적이 있음
- OIDC의 주요 실질적인 장점은 사용자 정보를 가져오기 위한 요청 횟수가 줄어든다는 점임 (OAuth의 경우 access token 확보 + 사용자 정보 조회로 2회, OIDC는 1회로 끝남)
- OAuth 스코프에 'openid' 값을 포함하면 ID Token이라는 JWT를 반환하고, 여기에 사용자의 정보들이 포함되어 있음

## 출처

- https://hudi.blog/oauth-2.0/
- https://hudi.blog/open-id/
